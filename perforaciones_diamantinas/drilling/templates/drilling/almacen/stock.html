{% extends 'drilling/base.html' %}

{% block title %}Stock de Almacén - Vilbragroup API{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-warehouse"></i> Stock de Almacén (Vilbragroup)</h2>
            <p class="text-muted">
                Consulta en tiempo real del inventario disponible en almacén
                {% if user.contrato and user.contrato.codigo_centro_costo %}
                    <br><strong>Centro de Costo:</strong> {{ user.contrato.codigo_centro_costo }} - {{ user.contrato.nombre_contrato }}
                {% else %}
                    <br><span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Sin centro de costo asignado</span>
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Tabs para alternar entre Productos Diamantados y Aditivos -->
    <ul class="nav nav-tabs mb-4" id="stockTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pdd-tab" data-bs-toggle="tab" data-bs-target="#pdd-content" 
                    type="button" role="tab" aria-controls="pdd-content" aria-selected="true">
                <i class="fas fa-gem"></i> Productos Diamantados
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="aditivos-tab" data-bs-toggle="tab" data-bs-target="#aditivos-content" 
                    type="button" role="tab" aria-controls="aditivos-content" aria-selected="false">
                <i class="fas fa-flask"></i> Aditivos
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="stockTabsContent">
        <!-- Productos Diamantados Tab -->
        <div class="tab-pane fade show active" id="pdd-content" role="tabpanel" aria-labelledby="pdd-tab">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-gem"></i> Productos Diamantados
                    <button class="btn btn-sm btn-light float-end" onclick="cargarStock('pdd')">
                        <i class="fas fa-sync-alt"></i> Recargar
                    </button>
                </div>
                <div class="card-body">
                    <div id="pdd-loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Consultando API...</p>
                    </div>
                    <div id="pdd-error" class="alert alert-danger d-none"></div>
                    <div id="pdd-table-container" class="d-none">
                        <div class="mb-3">
                            <input type="text" id="pdd-search" class="form-control" placeholder="Buscar por código, serie o descripción...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm" id="pdd-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="15%">Serie</th>
                                        <th width="15%">Código</th>
                                        <th width="55%">Descripción</th>
                                        <th width="15%" class="text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="pdd-summary" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aditivos Tab -->
        <div class="tab-pane fade" id="aditivos-content" role="tabpanel" aria-labelledby="aditivos-tab">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-flask"></i> Aditivos
                    <button class="btn btn-sm btn-light float-end" onclick="cargarStock('aditivos')">
                        <i class="fas fa-sync-alt"></i> Recargar
                    </button>
                </div>
                <div class="card-body">
                    <div id="aditivos-loading" class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Consultando API...</p>
                    </div>
                    <div id="aditivos-error" class="alert alert-danger d-none"></div>
                    <div id="aditivos-table-container" class="d-none">
                        <div class="mb-3">
                            <input type="text" id="aditivos-search" class="form-control" placeholder="Buscar por código o descripción...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm" id="aditivos-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="20%">Código</th>
                                        <th width="50%">Descripción</th>
                                        <th width="15%" class="text-center">Stock</th>
                                        <th width="15%" class="text-center">Unidad</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="aditivos-summary" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar productos diamantados al iniciar
    cargarStock('pdd');
    
    // Cargar aditivos cuando se cambia de tab
    const aditivosTab = document.getElementById('aditivos-tab');
    aditivosTab.addEventListener('shown.bs.tab', function() {
        const table = document.querySelector('#aditivos-table tbody');
        if (!table || table.rows.length === 0) {
            cargarStock('aditivos');
        }
    });
});

function cargarStock(tipo) {
    const apiUrl = tipo === 'pdd' 
        ? "{% url 'api-stock-pdd' %}" 
        : "{% url 'api-stock-aditivos' %}";
    
    const loadingDiv = document.getElementById(`${tipo}-loading`);
    const errorDiv = document.getElementById(`${tipo}-error`);
    const tableContainer = document.getElementById(`${tipo}-table-container`);
    
    // Mostrar loading
    loadingDiv.classList.remove('d-none');
    errorDiv.classList.add('d-none');
    tableContainer.classList.add('d-none');
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            loadingDiv.classList.add('d-none');
            
            if (data.error) {
                mostrarError(tipo, data.error);
            } else if (data.data && data.data.length > 0) {
                mostrarTabla(tipo, data.data);
            } else {
                mostrarError(tipo, 'No se encontraron artículos en el almacén');
            }
        })
        .catch(error => {
            loadingDiv.classList.add('d-none');
            mostrarError(tipo, error.message);
        });
}

function mostrarTabla(tipo, articulos) {
    const tableContainer = document.getElementById(`${tipo}-table-container`);
    const tbody = document.querySelector(`#${tipo}-table tbody`);
    const summaryDiv = document.getElementById(`${tipo}-summary`);
    
    // Limpiar tabla anterior
    tbody.innerHTML = '';
    
    if (tipo === 'pdd') {
        // Para Productos Diamantados: mostrar cada serie individualmente
        articulos.forEach(articulo => {
            const row = tbody.insertRow();
            
            // Serie
            const serieCell = row.insertCell(0);
            serieCell.textContent = articulo.serie || '-';
            serieCell.classList.add('font-monospace');
            
            // Código
            const codigoCell = row.insertCell(1);
            codigoCell.textContent = articulo.codigo || '-';
            codigoCell.classList.add('font-monospace', 'text-muted');
            
            // Descripción
            row.insertCell(2).textContent = articulo.descripcion || '-';
            
            // Estado (disponible/en uso)
            const estadoCell = row.insertCell(3);
            estadoCell.innerHTML = '<span class="badge bg-success">Disponible</span>';
            estadoCell.classList.add('text-center');
        });
        
        // Resumen agrupado por código
        const agrupado = {};
        articulos.forEach(art => {
            const codigo = art.codigo || 'SIN_CODIGO';
            if (!agrupado[codigo]) {
                agrupado[codigo] = {
                    descripcion: art.descripcion,
                    cantidad: 0
                };
            }
            agrupado[codigo].cantidad++;
        });
        
        const codigosOrdenados = Object.keys(agrupado).sort((a, b) => 
            agrupado[b].cantidad - agrupado[a].cantidad
        );
        
        let resumenHTML = '<div class="alert alert-info">';
        resumenHTML += `<strong><i class="fas fa-info-circle"></i> Resumen:</strong> `;
        resumenHTML += `${articulos.length} series disponibles en ${codigosOrdenados.length} códigos diferentes<br><br>`;
        resumenHTML += '<strong>Top 5 productos con más stock:</strong><ul class="mb-0 mt-2">';
        
        codigosOrdenados.slice(0, 5).forEach(codigo => {
            const info = agrupado[codigo];
            resumenHTML += `<li><code>${codigo}</code>: ${info.cantidad} unidades - ${info.descripcion.substring(0, 60)}${info.descripcion.length > 60 ? '...' : ''}</li>`;
        });
        
        resumenHTML += '</ul></div>';
        summaryDiv.innerHTML = resumenHTML;
        
        // Agregar búsqueda
        const searchInput = document.getElementById('pdd-search');
        searchInput.addEventListener('input', function() {
            filtrarTabla('pdd', this.value.toLowerCase());
        });
        
    } else {
        // Para Aditivos: mostrar con stock
        articulos.forEach(articulo => {
            const row = tbody.insertRow();
            
            // Código
            const codigoCell = row.insertCell(0);
            codigoCell.textContent = articulo.codigo || '-';
            codigoCell.classList.add('font-monospace');
            
            // Descripción
            row.insertCell(1).textContent = articulo.descripcion || '-';
            
            // Stock
            const stockCell = row.insertCell(2);
            const stock = parseFloat(articulo.stock || 0);
            stockCell.textContent = stock.toFixed(2);
            stockCell.classList.add('text-center', 'fw-bold');
            
            // Colorear según disponibilidad
            if (stock <= 0) {
                stockCell.classList.add('text-danger');
            } else if (stock < 10) {
                stockCell.classList.add('text-warning');
            } else {
                stockCell.classList.add('text-success');
            }
            
            // Unidad
            const unidadCell = row.insertCell(3);
            unidadCell.textContent = articulo.unidad || '-';
            unidadCell.classList.add('text-center');
        });
        
        // Resumen de aditivos
        const totalArticulos = articulos.length;
        const conStock = articulos.filter(a => parseFloat(a.stock || 0) > 0).length;
        const sinStock = totalArticulos - conStock;
        const stockCritico = articulos.filter(a => {
            const s = parseFloat(a.stock || 0);
            return s > 0 && s < 10;
        }).length;
        
        let resumenHTML = '<div class="alert alert-info">';
        resumenHTML += `<strong><i class="fas fa-info-circle"></i> Resumen:</strong> `;
        resumenHTML += `${totalArticulos} aditivos | `;
        resumenHTML += `<span class="text-success">${conStock} con stock</span> | `;
        resumenHTML += `<span class="text-warning">${stockCritico} en stock crítico</span> | `;
        resumenHTML += `<span class="text-danger">${sinStock} sin stock</span>`;
        resumenHTML += '</div>';
        summaryDiv.innerHTML = resumenHTML;
        
        // Agregar búsqueda
        const searchInput = document.getElementById('aditivos-search');
        searchInput.addEventListener('input', function() {
            filtrarTabla('aditivos', this.value.toLowerCase());
        });
    }
    
    tableContainer.classList.remove('d-none');
}

function filtrarTabla(tipo, searchTerm) {
    const tbody = document.querySelector(`#${tipo}-table tbody`);
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
}

function mostrarError(tipo, mensaje) {
    const errorDiv = document.getElementById(`${tipo}-error`);
    errorDiv.textContent = `Error: ${mensaje}`;
    errorDiv.classList.remove('d-none');
}
</script>
{% endblock %}
