{% extends 'drilling/base.html' %}

{% block title %}Asignar Actividades a Contrato{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-link"></i> Asignar Actividades a Contrato</h2>
            <div>
                <a href="{% url 'gestionar-actividades' %}" class="btn btn-info">
                    <i class="fas fa-cog"></i> Gestionar Actividades
                </a>
                <a href="{% url 'actividades-list' %}" class="btn btn-secondary">
                    <i class="fas fa-list"></i> Ver Lista
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Seleccionar Contrato y Actividades</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instrucciones:</strong> 
                    <ol class="mb-0">
                        <li>Seleccione un contrato del menú desplegable</li>
                        <li>Marque las actividades que desea asignar a ese contrato</li>
                        <li>Haga clic en "Guardar Asignación"</li>
                    </ol>
                </div>

                <!-- Selector de Contrato -->
                <form method="get" class="mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="contrato" class="form-label">
                                <i class="fas fa-building"></i> <strong>Contrato:</strong>
                            </label>
                            <select 
                                name="contrato" 
                                id="contrato" 
                                class="form-select form-select-lg" 
                                onchange="this.form.submit()"
                            >
                                <option value="">-- Seleccione un contrato --</option>
                                {% for contrato in contratos %}
                                <option value="{{ contrato.id }}" 
                                    {% if contrato_seleccionado and contrato.id == contrato_seleccionado.id %}selected{% endif %}>
                                    {{ contrato.nombre_contrato }} ({{ contrato.codigo_contrato }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Cargar
                            </button>
                        </div>
                    </div>
                </form>

                {% if contrato_seleccionado %}
                <hr>
                
                <!-- Información del Contrato Seleccionado -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-building"></i> {{ contrato_seleccionado.nombre_contrato }}</h5>
                    <p class="mb-0">
                        <strong>Código:</strong> {{ contrato_seleccionado.codigo_contrato }} | 
                        <strong>Estado:</strong> 
                        <span class="badge bg-success">{{ contrato_seleccionado.get_estado_display }}</span>
                    </p>
                </div>

                <!-- Formulario de Asignación -->
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="contrato_id" value="{{ contrato_seleccionado.id }}">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-tasks"></i> Seleccione las Actividades:</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="marcarTodas()">
                                <i class="fas fa-check-square"></i> Marcar Todas
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodas()">
                                <i class="fas fa-square"></i> Desmarcar Todas
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%" class="text-center">
                                        <input type="checkbox" id="check-all" onclick="toggleTodas(this)">
                                    </th>
                                    <th style="width: 25%">Nombre</th>
                                    <th style="width: 15%">Tipo</th>
                                    <th style="width: 40%">Descripción</th>
                                    <th style="width: 15%" class="text-center">
                                        <i class="fas fa-dollar-sign"></i> Cobrable
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for actividad in actividades %}
                                <tr class="actividad-row">
                                    <td class="text-center">
                                        <input 
                                            class="form-check-input actividad-checkbox" 
                                            type="checkbox" 
                                            name="actividad_{{ actividad.id }}"
                                            id="act_{{ actividad.id }}"
                                            {% if actividad.id in actividades_asignadas %}checked{% endif %}
                                        >
                                    </td>
                                    <td>
                                        <label for="act_{{ actividad.id }}" style="cursor: pointer; width: 100%;">
                                            <strong>{{ actividad.nombre }}</strong>
                                            {% if actividad.descripcion_corta %}
                                            <br><small class="text-muted">{{ actividad.descripcion_corta }}</small>
                                            {% endif %}
                                        </label>
                                    </td>
                                    <td>
                                        {% if actividad.tipo_actividad == 'OPERATIVO' %}
                                            <span class="badge bg-success">{{ actividad.get_tipo_actividad_display }}</span>
                                        {% elif actividad.tipo_actividad == 'INOPERATIVO' %}
                                            <span class="badge bg-danger">{{ actividad.get_tipo_actividad_display }}</span>
                                        {% elif actividad.tipo_actividad == 'STAND_BY_CLIENTE' %}
                                            <span class="badge bg-warning text-dark">{{ actividad.get_tipo_actividad_display }}</span>
                                        {% elif actividad.tipo_actividad == 'STAND_BY_ROCKDRILL' %}
                                            <span class="badge bg-info">{{ actividad.get_tipo_actividad_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ actividad.get_tipo_actividad_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ actividad.descripcion|truncatewords:20|default:"-" }}</small>
                                    </td>
                                    <td class="text-center">
                                        {% if actividad.es_cobrable %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Sí</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="fas fa-times"></i> No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        No hay actividades disponibles
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save"></i> Guardar Asignación
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-warning text-center mt-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Seleccione un contrato para comenzar</h5>
                    <p class="mb-0">Elija un contrato del menú desplegable para ver y asignar actividades</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Funciones para manejar checkboxes
function toggleTodas(source) {
    const checkboxes = document.querySelectorAll('.actividad-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
}

function marcarTodas() {
    const checkboxes = document.querySelectorAll('.actividad-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('check-all').checked = true;
}

function desmarcarTodas() {
    const checkboxes = document.querySelectorAll('.actividad-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('check-all').checked = false;
}

// Actualizar estado del checkbox "Marcar todas" cuando cambian los individuales
document.addEventListener('DOMContentLoaded', function() {
    const checkAll = document.getElementById('check-all');
    const checkboxes = document.querySelectorAll('.actividad-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            if (checkAll) {
                checkAll.checked = allChecked;
                checkAll.indeterminate = someChecked && !allChecked;
            }
        });
    });
    
    // Resaltar filas seleccionadas
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
                row.classList.add('table-active');
            } else {
                row.classList.remove('table-active');
            }
        });
        
        // Aplicar estilo inicial
        if (checkbox.checked) {
            checkbox.closest('tr').classList.add('table-active');
        }
    });
});
</script>

<style>
.actividad-row {
    transition: background-color 0.2s;
}

.actividad-row:hover {
    background-color: #f8f9fa;
}

.table-active {
    background-color: #e7f3ff !important;
}

.form-check-input {
    cursor: pointer;
    width: 1.2rem;
    height: 1.2rem;
}
</style>
{% endblock %}
